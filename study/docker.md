# docker

## 배포 방법들

### 방법 1. 소스코드를 직접 배포하는 방식

#### 1️⃣ &nbsp; 소스 파일 복사

* FTP 나 SFTP/SCP 등으로 소스 파일을 복사
    * 서버가 100 대면 100군데 복사함
* 변종: NFS/SMB 등의 공유 폴더를 만들고 서버에서 이를 mount 하는 방식
    * 서버가 100대라도 공유 폴더 한 군데만 올리면 OK
* 변종: 컴파일 방식의 언어는 실행 파일을 만들어서 공유하기도 함
    * 그러나 서버 환경이 완전히 동일하지 않으면 실행파일 실행이 안되는 경우가 있음 <br>
    이 때문에 소스를 받아와서 일일이 컴파일 하기도 함
* 단점
    * 소스코드 보안 문제
    * 소스코드 버전 추적 문제 및 로컬에서의 변경 사항 추적 문제

#### 2️⃣ &nbsp; git을 이용한 소스코드 복사

* 각 서버에서 소스 코드 저장소를 git clone 해두고 git fetch 를 이용해 변경 적용
* 변종: 컴파일 언어의 경우 빌드 결과물을 git 을 통해서 배포함
* 장점
    * git 에 의한 버전 관리
* 단점
    * 소스코드 보안 문제
    * 컴파일 결과물을 넣을 경우 git 저장소 용량이 너무 커짐

### 방법 2. 설치 패키지를 만들어 배포하는 방식

#### &rarr; 빌드 결과물 + 설정 파일 묶어서 OS 별 설치 패키지 생성

* OS 별 설치 파일
    * Windows → MSI
    * Ubuntu Linux → DEB
    * CentOS Linux → RPM
* 대부분의 OS 에서는 command line 으로 설치 패키지를 만드는 것도 가능하고 <br>
    설치 패키지를 command line 모드에서 설치하는 것도 가능함
* 장점
    * 소스 코드 보안
    * 패키지 생성시 버전 번호를 기재하면 버전 관리도 가능함
* 단점
    * 패키지를 생성, 배포, 설치하는 사이클이 오래 걸림

### 방법 3. 실행 환경 이미지를 만드는 방식

#### 1️⃣ &nbsp; 가상 서버 이미지를 이용하는 방식

* 실행 파일 및 설정 파일을 포함하는 가상 서버 이미지를 만들고 이 이미지의 가상 서버들을 띄우는 방식으로 배포하는 방식
* 장점
    * 소스 코드 보안
    * 완전히 동일한 실행 환경을 보장 (개발 때와 배포 때 환경이 달라지는 문제가 없음)
    * 가상 서버 내부에 대한 접근 권한이 없더라도 서비스 배포가 가능함
    * 가상 서버 이미지에 버전 번호 부여가 가능한 경우 버전 관리 용이
* 단점
    * 실행 파일 교체를 위해서는 기존 할당된 IP 그대로 유지하면서 가상 서버 교체해야 함
    * 보통 새 가상 서버를 미리 만들고, 순간적으로 IP 재할당 하는 방식을 사용
    * 서버 이미지 제작 및 서버 교체 때문에 배포 시간 오래 걸림
* 참고 : Virtual Appliance : 특정 목적의 서비스만을 포함하는 가상 서버 이미지

#### 2️⃣ &nbsp; 컨테이너를 이용하는 방식
* 가상 서버 이미지가 아니라 컨테이너 이미지를 만들어 이를 이용하는 방식 <br>
즉, 가상서버는 그대로 두고, 그 안에 프로세스 형태로 존재하는 컨테이너를 교체

* 장점 
    * 소스 코드 보안
    * 완전히 동일한 실행 환경을 보장 (개발 때와 배포 떄 환경이 달라지는 문제 없음)
    * 컨테이너 내부에 대한 접근 권한이 없더라도 서비스 배포가 가능함
    * 컨테이너 이미지에 버전 번호 부여가 가능한 경우 버전 관리 용이

### 가상 서버 VS 컨테이너

| | 가상 서버 | 컨테이너|
|--|--|--|
| 특징 | OS를 가상화 함 <br> - 각각의 독립된 OS | Namespace 를 가상화 함 <br> - 프로세스 ID <br> - User ID <br> - Network (port) |
| 장점 | - 서로 다른 OS 설치 가능 <br> - Isolation 수준이 더 높음 | Guest OS 부담이 없으므로 가벼움 |
| 단점 | - 가상화를 위해 Guest OS 부담이 계속 생김 | - 다른 OS 설치 불가능 <br> - 같은 OS 공유하므로 다른 컨테이너 프로세스에 의해 <br> &nbsp;전체 OS 성능이 영향을 받을 수 있음  |

## Docker

* 이전 컨테이너 기술
    * Linux Container (LXC)
    * FreeBSD Jail 
    * ...

### 그 중 가장 널리 쓰이게 된 것이 Docker

## Docker Hub

### Docker image 저장소

* Docker 에서 공식적으로 배포하는 이미지도 포함됨

* Github 도 일반 사용자가 자신의 코드를 올릴 수 있는 것 처럼 Docker hub도 일반 사용자의 docker image를 올릴 수 있음

* 만일 docker image를 파일로 export 하여 그걸 직접 서버에 복사하고 다시 서버에서 import 하여 쓰는 것이 아니라면 <br>
docker hub 를 통해 편리하게 docker image를 서버에 공유할 수 있습니다.

### Docer Hub 이용한 Docker Image 배포

![docker_1](/asset/img/docker_1.png)

### Dockerfile
 
* Docker image 생성 방법을 지정하는 입력 파일

* 한 줄에 하나씩 “명령어 인자” 형태로 작성함
 
#### 많이 사용하는 명령어
* FROM : Base 이미지 지정
* RUN  : 컨테이너 실행 전 수행할 명령
* CMD  : 컨테이너 시작 시 실행될 명령어
* COPY : 파일이나 폴더를 이미지 안에 복사해 넣는 명령어

### Docker Image 생성 방식 (Layering)

* Dockerfile 에 기본 이미지를 지정하고 customizing 할 내용을 기재하는 방식으로 생성합니다.

    ![docker_2](/asset/img/docker_2.png)

